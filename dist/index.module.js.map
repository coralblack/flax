{"mappings":"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","sources":["./src/request.ts","./src/components/FxButton.tsx","./src/components/FxGuard.tsx"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport axios, {AxiosResponse, ResponseType} from 'axios';\nimport LRU from 'lru-cache';\nimport queryString from 'query-string';\nimport {MutableRefObject} from 'react';\n\nconst cache = new LRU({max: 100, maxAge: 1000 * 60 * 10});\n\ntype QueryType = string | number | boolean;\ntype Queries = {[key: string]: QueryType | QueryType[]};\ntype Headers = {[key: string]: string};\ntype DataTypeValues = string | number | boolean | null;\ntype DataType = {\n  [key: string]: DataTypeValues | MutableRefObject<HTMLElement> | DataType;\n};\ntype Data = DataType | (() => DataType) | string;\n\nexport interface FxApiRequest {\n  method: 'GET' | 'POST' | 'DELETE' | 'PATCH' | 'PUT';\n  url: string;\n  cacheMaxAge?: number;\n  throttle?: boolean;\n  delay?: number;\n  responseType?: ResponseType;\n  query?: Queries;\n  headers?: Headers;\n  data?: Data;\n}\n\ninterface RequestProps extends FxApiRequest {\n  refreshId?: number;\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\ntype Resolver = (data: any) => void;\ntype Rejector = (reason: Error) => void;\n\nconst resolvers: {\n  [key: string]: Array<{resolve: Resolver; reject: Rejector}>;\n} = {};\nconst resolver = (\n  resolver: {resolve: Resolver; reject: Rejector},\n  key: string | null,\n  resp: AxiosResponse | null,\n  error: Error | null\n) => {\n  if (!key) {\n    if (error) {\n      resolver.reject(error);\n    } else {\n      resolver.resolve({data: resp?.data, response: resp});\n    }\n    return;\n  }\n\n  const res = resolvers[key].splice(0, resolvers[key].length);\n\n  res.forEach(({resolve, reject}) => {\n    if (error) {\n      reject(error);\n    } else {\n      resolve({data: resp?.data, response: resp});\n    }\n  });\n};\n\nconst dataMapper = (data: DataType | string | null | undefined) => {\n  if (!data) return data;\n  if (typeof data !== 'object') return data;\n\n  return Object.keys(data).reduce<{[key: string]: any}>((p, c) => {\n    if (typeof data[c] === 'object') {\n      if ((data[c] as any).current instanceof HTMLElement) {\n        p[c] = (data[c] as any).current.value;\n      } else {\n        p[c] = dataMapper(data[c] as any);\n      }\n    } else {\n      p[c] = data[c];\n    }\n    return p;\n  }, {});\n};\n\nexport type FxResp<T> = {data: T; response: AxiosResponse};\n\nexport function request<T>(props: RequestProps): Promise<FxResp<T>> {\n  return new Promise<FxResp<T>>((resolve, reject) => {\n    setTimeout(() => {\n      const url = ((u, query) => {\n        const qs = queryString.stringify(query);\n        return u + (qs ? (u.includes('?') ? '&' : '?') + qs : '');\n      })(props.url, props.query || {});\n\n      const cacheKey =\n        props.method === 'GET' && props.cacheMaxAge && props.cacheMaxAge > 0\n          ? ''\n          : null;\n      const cached = cacheKey && cache.get(cacheKey);\n      const lazyGroup =\n        props.method === 'GET' && props.throttle\n          ? `${props.method} ${url}`\n          : null;\n\n      if (lazyGroup) {\n        resolvers[lazyGroup] = resolvers[lazyGroup] || [];\n        resolvers[lazyGroup].push({resolve, reject});\n\n        // Duplicated `GET` request,\n        if (resolvers[lazyGroup].length > 1) {\n          return;\n        }\n      }\n\n      if (cached) {\n        resolve(cached);\n        return;\n      }\n\n      const start = new Date().getTime();\n\n      axios\n        .request<T>({\n          method: props.method,\n          url,\n          headers: props.headers,\n          responseType: props.responseType,\n          data: dataMapper(\n            typeof props.data === 'function' ? props.data() : props.data\n          ),\n        })\n        .then(resp => {\n          const delay = (props.delay || 0) - (new Date().getTime() - start);\n\n          setTimeout(() => {\n            resolver({resolve, reject}, lazyGroup, resp, null);\n          }, Math.max(0, delay));\n        })\n        .catch(err => {\n          resolver({resolve, reject}, lazyGroup, null, err);\n        });\n    }, 25);\n  });\n}\n","import {AxiosResponse} from 'axios';\nimport React, {Component, ReactNode} from 'react';\nimport {FxApiRequest, request} from '../request';\n\ntype DoneDelegate<T> = (\n  res: T | null,\n  error: Error | null,\n  resp?: AxiosResponse | null\n) => void;\ntype SucceedDelegate<T> = (res: T, resp: AxiosResponse) => void;\ntype ErrorDelegate = (error: Error) => void;\n\ninterface FxButtonProps<T> {\n  children?: ReactNode;\n  className?: string;\n  label?: string;\n\n  api: FxApiRequest;\n  done?: DoneDelegate<T>;\n  success?: SucceedDelegate<T>;\n  error?: ErrorDelegate;\n}\n\ninterface FxButtonStates {\n  busy: boolean;\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport class FxButton<T = any> extends Component<\n  FxButtonProps<T>,\n  FxButtonStates\n> {\n  constructor(props: FxButtonProps<T>) {\n    super(props);\n\n    this.state = {\n      busy: false,\n    };\n  }\n\n  handleClick() {\n    if (this.state.busy) return;\n\n    this.setState({...this.state, busy: true});\n\n    request<T>({...this.props.api})\n      .then(res => {\n        this.props.success && this.props.success(res.data, res.response);\n        this.props.done && this.props.done(res.data, null, res.response);\n        this.setState({...this.state, busy: false});\n      })\n      .catch(err => {\n        this.props.error && this.props.error(err);\n        this.props.done && this.props.done(null, err, null);\n        this.setState({...this.state, busy: false});\n      });\n  }\n\n  render() {\n    return (\n      <button\n        className=\"fx-button\"\n        onClick={() => this.handleClick()}\n        disabled={this.state.busy}\n      >\n        {this.props.children || this.props.label}\n      </button>\n    );\n  }\n}\n","import React, {Component, Suspense, useEffect, useState} from 'react';\nimport {request, FxApiRequest, FxResp} from '../request';\n\ntype Renderer<T> = (data: T) => React.ReactNode;\n\ntype LazyStatus = 'PENDING' | 'SUCCESS' | 'ERROR';\ninterface Lazy<T> {\n  status: LazyStatus;\n  error: Error | null;\n  result: T | null;\n}\n\nfunction lazyResponse<T>(\n  res: FxResp<T> | null,\n  error: Error | null\n): () => {status: LazyStatus; result: T | null; error: Error | null} {\n  return () => ({\n    status: error ? 'ERROR' : 'SUCCESS',\n    result: res?.data || null,\n    error: error,\n  });\n}\n\nconst lazy = function <T>(\n  release: ReleaseDelegateInternal,\n  p: Promise<FxResp<T>>\n) {\n  let status: LazyStatus = 'PENDING';\n  let error: Error | null;\n  let result: T | null;\n\n  p.then(res => {\n    ({result, status, error} = lazyResponse<T>(res, null)());\n    release(true);\n  }).catch(err => {\n    ({result, status, error} = lazyResponse<T>(null, err)());\n    release(false);\n  });\n\n  return (): Lazy<T> => {\n    if (status === 'PENDING') throw p;\n\n    return {\n      status,\n      error,\n      result,\n    };\n  };\n};\n\ninterface FxGuardInnerProps<T> extends FxGuardProps<T> {\n  releaseBusy: ReleaseDelegateInternal;\n  refreshId: number;\n  reloadId: number;\n}\n\nfunction FxGuardInner<T>(props: FxGuardInnerProps<T>) {\n  const [prepared, setPrepared] = useState<Function>();\n  const {api, refreshId, reloadId} = props;\n  const req = () => {\n    return request<T>(\n      Object.assign(\n        {\n          throttle: api.throttle === false ? false : true,\n          refreshId,\n        },\n        props.api\n      )\n    );\n  };\n\n  useEffect(() => {\n    if (reloadId > 0) {\n      req()\n        .then(res => {\n          setPrepared(() => lazyResponse<T>(res, null));\n          props.releaseBusy(true);\n        })\n        .catch(err => {\n          setPrepared(() => lazyResponse<T>(null, err));\n          props.releaseBusy(false);\n        });\n    }\n  }, [reloadId]);\n\n  useEffect(() => {\n    setPrepared(() => lazy<T>(props.releaseBusy, req()));\n  }, [api.method, api.url, refreshId]);\n\n  if (!prepared) return <></>;\n\n  const resp = prepared();\n\n  if (resp.status === 'ERROR') {\n    return (\n      <>\n        <div>Error ({resp.error.message})</div>\n      </>\n    );\n  }\n\n  return <>{props.render(resp.result)}</>;\n}\n\ninterface FxGuardProps<T> {\n  api: FxApiRequest;\n  render: Renderer<T>;\n  done?: ReleaseDelegate;\n}\n\ntype ReleaseDelegate = (succeed?: boolean) => void;\ntype ReleaseDelegateInternal = (succeed: boolean) => void;\ninterface FxGuardStates {\n  refreshId: number;\n  reloadId: number;\n  busy: boolean;\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport class FxGuard<T = any> extends Component<\n  FxGuardProps<T>,\n  FxGuardStates\n> {\n  constructor(props: FxGuardProps<T>) {\n    super(props);\n\n    this.state = {\n      refreshId: 0,\n      reloadId: 0,\n      busy: false,\n    };\n  }\n\n  reload(silent?: boolean) {\n    if (this.state.busy) return;\n\n    if (silent) {\n      this.setState({\n        ...this.state,\n        reloadId: this.state.reloadId + 1,\n        busy: true,\n      });\n      return;\n    }\n\n    this.setState({\n      ...this.state,\n      refreshId: this.state.refreshId + 1,\n      busy: true,\n    });\n  }\n\n  releaseBusy(succeed: boolean) {\n    if (this.props.done) {\n      this.props.done(succeed);\n    }\n\n    this.setState({\n      ...this.state,\n      busy: false,\n    });\n  }\n\n  render() {\n    return (\n      <div className=\"fx-guard\">\n        <Suspense fallback={<div className=\"fx-guard-loader\">Loading ..</div>}>\n          <FxGuardInner<T>\n            releaseBusy={succeed => this.releaseBusy(succeed)}\n            refreshId={this.state.refreshId}\n            reloadId={this.state.reloadId}\n            api={this.props.api}\n            render={this.props.render}\n          />\n        </Suspense>\n      </div>\n    );\n  }\n}\n"],"names":["cache","LRU","max","maxAge","resolvers","resolver","key","resp","error","reject","resolve","data","response","splice","length","forEach","dataMapper","Object","keys","reduce","p","c","current","HTMLElement","value","request","props","Promise","setTimeout","url","u","query","qs","queryString","stringify","includes","cacheKey","method","cacheMaxAge","cached","get","lazyGroup","throttle","concat","push","start","Date","getTime","axios","headers","responseType","then","delay","Math","catch","err","FxButton","Component","constructor","super","this","state","busy","handleClick","setState","$cff2b6d75cbbcf34f8ecc2d690e62f7a$var$_objectSpread","$e37d50e173cfeed719d55c3076a8beab$export$request","api","res","success","done","render","_react","createElement","className","onClick","disabled","children","label","lazyResponse","status","result","FxGuardInner","prepared","setPrepared","useState","refreshId","reloadId","req","assign","useEffect","releaseBusy","release","lazy","Fragment","message","FxGuard","reload","silent","$b3391a37da12f524ec061e62849b526d$var$_objectSpread","succeed","Suspense","fallback","$b3391a37da12f524ec061e62849b526d$var$FxGuardInner"],"version":3,"file":"index.module.js.map"}